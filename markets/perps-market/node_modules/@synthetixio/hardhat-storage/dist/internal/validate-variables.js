"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.validateMutableStateVariables = void 0;
const contracts_1 = require("@synthetixio/core-utils/utils/hardhat/contracts");
const contract_names_1 = require("hardhat/utils/contract-names");
const error_1 = require("./error");
const iterators_1 = require("./iterators");
function validateMutableStateVariables({ sourceUnits, skip }) {
    const contractNodes = [
        // Filter out contracts that are marked to be skipped
        ...(0, iterators_1.iterateContracts)(sourceUnits, (sourceUnit, contractNode) => {
            const sourceName = sourceUnit.absolutePath;
            const contractName = contractNode.name;
            const fqName = (0, contract_names_1.getFullyQualifiedName)(sourceName, contractName);
            return (0, contracts_1.filterContracts)([fqName, sourceName, contractName], skip).length === 0;
        }),
    ];
    // Find state variables
    const invalidVars = [...(0, iterators_1.iterateVariables)(contractNodes, _isMutableStateVariable)];
    return invalidVars.map(([sourceUnit, contractNode, variableNode]) => (0, error_1.createError)({
        message: 'Unsafe state variable declaration. Mutable state variables cannot be declared on a contract behind a Proxy',
        sourceUnit,
        nodes: [contractNode, variableNode],
    }));
}
exports.validateMutableStateVariables = validateMutableStateVariables;
function _isMutableStateVariable(variableNode) {
    return (variableNode.stateVariable &&
        variableNode.mutability !== 'constant' &&
        variableNode.mutability !== 'immutable');
}
//# sourceMappingURL=validate-variables.js.map